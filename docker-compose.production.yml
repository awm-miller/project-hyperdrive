version: "3.8"

services:
  # Shared job queue
  redis-queue:
    image: redis:7-alpine
    container_name: redis-queue
    ports:
      - "6379:6379"
    volumes:
      - redis-queue-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # === Worker 1 Stack ===
  nitter-redis-1:
    image: redis:7-alpine
    container_name: nitter-redis-1
    volumes:
      - nitter-redis-1-data:/data
    restart: unless-stopped

  nitter-1:
    image: zedeus/nitter:latest
    container_name: nitter-1
    ports:
      - "8081:8080"
    volumes:
      - ./nitter-worker1.conf:/src/nitter.conf:ro
      - ./sessions.jsonl:/src/sessions.jsonl:ro
    depends_on:
      - nitter-redis-1
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  worker-1:
    build:
      context: .
      dockerfile: deploy/worker.Dockerfile
    container_name: worker-1
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - WORKER_ID=worker1
      - NITTER_URL=http://nitter-1:8080
      - REDIS_URL=redis://redis-queue:6379
      - NITTER_REDIS_HOST=nitter-redis-1
      - MULLVAD_ACCOUNT=${MULLVAD_ACCOUNT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    depends_on:
      redis-queue:
        condition: service_healthy
      nitter-1:
        condition: service_healthy
    restart: unless-stopped

  # === Worker 2 Stack ===
  nitter-redis-2:
    image: redis:7-alpine
    container_name: nitter-redis-2
    volumes:
      - nitter-redis-2-data:/data
    restart: unless-stopped

  nitter-2:
    image: zedeus/nitter:latest
    container_name: nitter-2
    ports:
      - "8082:8080"
    volumes:
      - ./nitter-worker2.conf:/src/nitter.conf:ro
      - ./sessions.jsonl:/src/sessions.jsonl:ro
    depends_on:
      - nitter-redis-2
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  worker-2:
    build:
      context: .
      dockerfile: deploy/worker.Dockerfile
    container_name: worker-2
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - WORKER_ID=worker2
      - NITTER_URL=http://nitter-2:8080
      - REDIS_URL=redis://redis-queue:6379
      - NITTER_REDIS_HOST=nitter-redis-2
      - MULLVAD_ACCOUNT=${MULLVAD_ACCOUNT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    depends_on:
      redis-queue:
        condition: service_healthy
      nitter-2:
        condition: service_healthy
    restart: unless-stopped

volumes:
  redis-queue-data:
  nitter-redis-1-data:
  nitter-redis-2-data:

